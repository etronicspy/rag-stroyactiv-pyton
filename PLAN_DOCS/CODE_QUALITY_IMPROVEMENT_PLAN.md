# Code Quality Improvement Plan

_Дата: 2025-06-23_

Цель — повысить читаемость, надёжность и тестируемость кода без изменения бизнес-логики приложения.

## 1. Статический анализ
✅ Выполнено — конфигурация `mypy --strict`, `ruff`, плагины flake8 и pre-commit добавлены (2025-06-23).

## 2. Тестовое покрытие
- Расширить unit-тесты для `core/database` adapters и middleware (граничные случаи, исключения).
- Добавить интеграционные тесты для health-checks и fallback-стратегии (**vector → SQL**).

## 3. Контрактность и валидация
- Использовать `field_validator` во всех Pydantic-настройках `.env`.
- Добавить runtime-assertions в критичных точках (ID, типы коллекций).

## 4. Документация API
- Проверить docstrings (Google style) для всех публичных классов/функций.
- Расширить OpenAPI: документировать все нестандартные 4xx/5xx ответы.

## 5. Модульный рефакторинг
- Декомпозировать файлы > 500 строк (`core/logging/*`, `services/price_processor.py`).
- Выделить интерфейсы (ABC) для кешей и внешних API, внедрять через DI.

## 6. Исключение глобальных синглтонов
- Перейти на FastAPI `Depends` для логгеров и метрик.
- Ограничить использование `lru_cache` только действительно тяжёлыми фабриками.

## 7. Производительность
- Заменить блокирующие вызовы (`psutil.cpu_percent(interval=1)`) на асинхронные или кэшированные.
- В middleware/compression вычислять приоритет алгоритма один раз на старте.

## 8. CI/CD
- Добавить `pre-commit` шаг `ruff --fix`.
- Настроить CI (GitHub/Bitbucket): ruff, mypy, pytest, safety.

## 9. Обработка ошибок
- Ловить конкретные исключения (например, `QdrantClientException`, `RedisError`).
- Использовать фабрику ошибок для генерации пользовательских сообщений.

## 10. Улучшение типизации
- Заменить `Dict[str, Any]` на `TypedDict` или `Protocol`.
- Применять `Literal["qdrant", "weaviate", "pinecone"]` для `database_type`.

---

_Ответственный_: ⟨указать имя⟩  
_Запланированная версия_: ⟨v0.2.0⟩  
_Оценка трудозатрат_: 3–4 недели (с учётом ревью и CI). 