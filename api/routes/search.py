from fastapi import APIRouter, Query, HTTPException
from typing import List
from core.monitoring.logger import get_logger

from core.schemas.materials import Material
from services.materials import MaterialsService

logger = get_logger(__name__)
router = APIRouter()

@router.get("/", response_model=List[Material])
async def search_materials(
    q: str = Query(..., description="Search query"),
    limit: int = Query(10, description="Maximum number of results to return")
) -> List[Material]:
    """
    üîç **Simple Material Search** - –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
    
    –ü—Ä–æ—Å—Ç–æ–π –∏ –±—ã—Å—Ç—Ä—ã–π endpoint –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —á–µ—Ä–µ–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
    –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ø—Ä–æ—Å—Ç—ã–º–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞–º–∏.
    
    **üîÑ Search Strategy:**
    1. **Vector Search**: –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ embedding
    2. **Fallback to SQL**: –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    3. **Error Handling**: Graceful degradation –ø—Ä–∏ —Å–±–æ—è—Ö
    
    **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
    - ‚ö° GET –∑–∞–ø—Ä–æ—Å - –º–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å
    - üîó –ü—Ä–æ—Å—Ç—ã–µ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    - üß† AI-powered —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
    - üõ°Ô∏è Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
    - üì± –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
    
    **Query Parameters:**
    - `q`: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π, min: 1 —Å–∏–º–≤–æ–ª)
    - `limit`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (default: 10, max: 100)
    
    **URL Examples:**
    - `GET /search/?q=—Ü–µ–º–µ–Ω—Ç&limit=5`
    - `GET /search/?q=–∞—Ä–º–∞—Ç—É—Ä–∞%20—Å—Ç–∞–ª—å–Ω–∞—è&limit=20`
    - `GET /search/?q=–∫–∏—Ä–ø–∏—á%20–∫—Ä–∞—Å–Ω—ã–π`
    
    **Response Example:**
    ```json
    [
        {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "name": "–ü–æ—Ä—Ç–ª–∞–Ω–¥—Ü–µ–º–µ–Ω—Ç –ú500 –î0",
            "use_category": "–¶–µ–º–µ–Ω—Ç",
            "unit": "–º–µ—à–æ–∫",
            "sku": "CEM500-001",
            "description": "–í—ã—Å–æ–∫–æ–ø—Ä–æ—á–Ω—ã–π —Ü–µ–º–µ–Ω—Ç –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ –±–µ—Ç–æ–Ω–∞",
            "embedding": null, // Hidden in search results
            "created_at": "2025-06-16T16:46:29.421964Z",
            "updated_at": "2025-06-16T16:46:29.421964Z"
        },
        {
            "id": "550e8400-e29b-41d4-a716-446655440001",
            "name": "–¶–µ–º–µ–Ω—Ç –ú400 –±—ã—Å—Ç—Ä–æ—Ç–≤–µ—Ä–¥–µ—é—â–∏–π",
            "use_category": "–¶–µ–º–µ–Ω—Ç",
            "unit": "—Ç",
            "sku": "CEM400-BT",
            "description": "–ë—ã—Å—Ç—Ä–æ—Ç–≤–µ—Ä–¥–µ—é—â–∏–π –ø–æ—Ä—Ç–ª–∞–Ω–¥—Ü–µ–º–µ–Ω—Ç –¥–ª—è —Å—Ä–æ—á–Ω—ã—Ö —Ä–∞–±–æ—Ç",
            "embedding": null,
            "created_at": "2025-06-16T16:46:29.421964Z",
            "updated_at": "2025-06-16T16:46:29.421964Z"
        }
    ]
    ```
    
    **Response Status Codes:**
    - **200 OK**: –ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫)
    - **400 Bad Request**: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
    - **500 Internal Server Error**: –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞
    
    **Search Tips:**
    - **–¢–æ—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: `"—Ü–µ–º–µ–Ω—Ç –ú500"` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–∞—Ä–∫—É
    - **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏**: `"–∞—Ä–º–∞—Ç—É—Ä–∞"` ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –≤–∏–¥—ã –∞—Ä–º–∞—Ç—É—Ä—ã
    - **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏**: `"–∫–∏—Ä–ø–∏—á –∫—Ä–∞—Å–Ω—ã–π"` ‚Üí –ø–æ —Ü–≤–µ—Ç—É –∏ —Ç–∏–ø—É
    - **–°–∏–Ω–æ–Ω–∏–º—ã**: `"–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω"` ‚Üí –Ω–∞–π–¥–µ—Ç "–ñ–ë–ò", "–±–µ—Ç–æ–Ω –∞—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π"
    
    **Use Cases:**
    - üåê AJAX –ø–æ–∏—Å–∫ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
    - üì± –ú–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    - üîó –ü—Ä–æ—Å—Ç—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ GET
    - ‚ö° –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ö
    - üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É
    
    **Performance:**
    - ‚ö° –û—Ç–∫–ª–∏–∫: < 300ms
    - üß† –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑: –≤–∫–ª—é—á–µ–Ω
    - üíæ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ: —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
    - üìä –õ–∏–º–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è
    """
    try:
        service = MaterialsService()
        return await service.search_materials(query=q, limit=limit)
    except Exception as e:
        logger.error(f"Search error: {e}")
        raise HTTPException(status_code=500, detail="Internal server error during search") 