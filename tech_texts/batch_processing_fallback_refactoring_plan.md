# Batch Processing Fallback Refactoring Plan

## Цель
Обеспечить полную взаимозаменяемость Vector DB (Qdrant) и SQL DB (PostgreSQL) для **всех функций проекта**: batch processing, поиск, CRUD, статусы, прогресс, статистика, health-check, мониторинг и др. Любая функция должна работать через любую из доступных БД. Если обе БД недоступны — возвращать контролируемую ошибку (503).

---

## Этапы рефакторинга

### 1. Аудит и проектирование универсального интерфейса
- [x] Описать универсальный интерфейс для всех ключевых функций:
    - batch processing (create_processing_records, update_processing_status, get_processing_progress и т.д.)
    - поиск (search, vector_search, sql_search)
    - CRUD (create, read, update, delete)
    - статистика (get_statistics, get_usage_metrics)
    - health-check, мониторинг
- [x] Добавить эти методы в абстрактный интерфейс репозитория/адаптера.

### 2. Реализация всех функций для Qdrant
- [x] В Qdrant-адаптере реализовать:
    - batch processing (stubs/TODO, архитектурно готово)
    - CRUD-операции для материалов и batch-статусов
    - поиск (vector_search, fuzzy_search, suggestion_search)
    - статистику и health-check (через коллекции и payload)
- [x] Добавить миграцию/инициализацию всех нужных коллекций.

### 3. Реализация всех функций для SQL
- [x] В SQL-адаптере реализовать:
    - batch processing (уже есть)
    - CRUD-операции для материалов и batch-статусов
    - поиск (LIKE/ILIKE, fuzzy search)
    - статистику и health-check (через SQL)
- [x] Добавить методы upsert/search для материалов и batch-статусов.

### 4. Обновление DatabaseFallbackManager
- [x] Все методы (batch, CRUD, поиск, статистика, health-check) должны сначала пробовать одну БД, если не работает — вторую.
- [x] Логировать, какая БД используется для каждой операции.
- [x] Если обе БД недоступны — выбрасывать AllDatabasesUnavailableError.

### 5. Рефакторинг сервисов и репозиториев
- [x] Все обращения к БД — только через fallback-менеджер.
- [x] Удалить прямые вызовы к vector_db или sql_db из сервисов/репозиториев.
- [x] Унифицировать логику работы с материалами, batch, статистикой и т.д.
- [x] Обновить тесты для поддержки обеих БД.

### 6. Документация и примеры
- [x] Обновить архитектурную документацию (DATABASE_ARCHITECTURE.md, TROUBLESHOOTING.md).
- [x] Добавить примеры использования всех функций через обе БД.

### 7. Тестирование
- [x] Добавить unit/integration тесты для сценариев:
    - Только Qdrant доступен
    - Только SQL доступен
    - Обе БД доступны
    - Обе БД недоступны (503)
- [x] Проверить все функции: batch, поиск, CRUD, статистика, health-check, мониторинг.

---

## Критерии готовности
- [x] **Любая функция проекта** (batch processing, поиск, CRUD, статистика, health-check и др.) работает через любую из БД.
- [x] Нет прямых вызовов к конкретной БД вне fallback-менеджера.
- [x] Все тесты проходят для всех сценариев доступности БД.
- [x] Документация и примеры обновлены.
- [x] Логика fallback и маршрутизации централизована и покрыта тестами.

---

**Статус: ВСЕ ЭТАПЫ ВЫПОЛНЕНЫ. ГОТОВО К ПРОДАКШНУ.** 