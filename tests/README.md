# ๐งช ะขะตััะพะฒะฐั ัะธััะตะผะฐ RAG Construction Materials API

## ๐ ะะฑะทะพั

ะขะตััะพะฒะฐั ัะธััะตะผะฐ ะพัะณะฐะฝะธะทะพะฒะฐะฝะฐ ะฟะพ ะฟัะธะฝัะธะฟั ัะฐะทะดะตะปะตะฝะธั ะฝะฐ ัะธะฟั ัะตััะพะฒ ั ะฐะฒัะพะผะฐัะธัะตัะบะธะผ ะฟะตัะตะบะปััะตะฝะธะตะผ ะผะตะถะดั mock ะธ ัะตะฐะปัะฝัะผะธ ะะ. ะกะธััะตะผะฐ ะฟะพะดะดะตัะถะธะฒะฐะตั ัะตัััะต ะพัะฝะพะฒะฝัั ัะธะฟะฐ ัะตััะพะฒ:

- **Unit ัะตััั** - ะฑัััััะต ัะตััั ั ะผะพะบะฐะผะธ
- **Integration ัะตััั** - ัะตััั ั ัะตะฐะปัะฝัะผะธ ะะ
- **Functional ัะตััั** - end-to-end ััะตะฝะฐัะธะธ
- **Performance ัะตััั** - ัะตััั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

## ๐ ะกัััะบัััะฐ

```
tests/
โโโ conftest.py                 # ะะดะธะฝะฐั ะบะพะฝัะธะณััะฐัะธั ะฒัะตั ัะตััะพะฒ
โโโ pytest.ini                 # ะะพะฝัะธะณััะฐัะธั pytest
โโโ README.md                   # ะะพะบัะผะตะฝัะฐัะธั (ััะพั ัะฐะนะป)
โโโ unit/                       # Unit ัะตััั ั ะผะพะบะฐะผะธ
โ   โโโ __init__.py
โ   โโโ test_api_endpoints.py   # ะขะตััั API ัะฝะดะฟะพะธะฝัะพะฒ
โ   โโโ test_services.py        # ะขะตััั ัะตัะฒะธัะพะฒ
โ   โโโ test_middleware.py      # ะขะตััั middleware
โ   โโโ test_utils.py          # ะขะตััั ััะธะปะธั
โโโ integration/                # ะะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั
โ   โโโ __init__.py
โ   โโโ test_materials_workflow.py    # Workflow ะผะฐัะตัะธะฐะปะพะฒ
โ   โโโ test_database_operations.py  # ะะฟะตัะฐัะธะธ ั ะะ
โ   โโโ test_file_processing.py      # ะะฑัะฐะฑะพัะบะฐ ัะฐะนะปะพะฒ
โ   โโโ test_vector_search.py        # ะะตะบัะพัะฝัะน ะฟะพะธัะบ
โโโ functional/                 # ะคัะฝะบัะธะพะฝะฐะปัะฝัะต ัะตััั
โ   โโโ __init__.py
โ   โโโ test_complete_workflows.py   # ะะพะปะฝัะต ััะตะฝะฐัะธะธ
โ   โโโ test_api_scenarios.py        # API ััะตะฝะฐัะธะธ
โโโ performance/                # ะขะตััั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ
โ   โโโ __init__.py
โ   โโโ test_load_testing.py         # ะะฐะณััะทะพัะฝัะต ัะตััั
โ   โโโ test_optimization.py         # ะขะตััั ะพะฟัะธะผะธะทะฐัะธะธ
โ   โโโ test_monitoring.py           # ะะพะฝะธัะพัะธะฝะณ
โโโ fixtures/                   # ะะฑัะธะต ัะธะบััััั
โ   โโโ __init__.py
โ   โโโ data_fixtures.py        # ะขะตััะพะฒัะต ะดะฐะฝะฝัะต
โ   โโโ mock_fixtures.py        # Mock ะพะฑัะตะบัั
โ   โโโ database_fixtures.py    # ะะ ัะธะบััััั
โโโ data/                      # ะขะตััะพะฒัะต ะดะฐะฝะฝัะต ัะฐะนะปั
    โโโ *.csv
    โโโ *.json
    โโโ test_data_helper.py
```

## ๐ ะัััััะน ััะฐัั

### ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
```bash
make install-test-deps
```

### ะะฐะฟััะบ ัะตััะพะฒ
```bash
# ะัััััะต unit ัะตััั
make test-unit

# ะะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั
make test-integration

# ะัะต ัะตััั
make test-all

# ะขะตััั ั ะฐะฝะฐะปะธะทะพะผ ะฟะพะบัััะธั
make test-coverage
```

## ๐ฏ ะขะธะฟั ัะตััะพะฒ

### Unit ัะตััั
- **ะะฐัะบะตั**: `@pytest.mark.unit`
- **ะะตะถะธะผ**: ะะฒัะพะผะฐัะธัะตัะบะธะต ะผะพะบะธ
- **ะกะบะพัะพััั**: ะัะตะฝั ะฑัััััะต (< 1 ัะตะบ ะฝะฐ ัะตัั)
- **ะะฐะทะฝะฐัะตะฝะธะต**: ะขะตััะธัะพะฒะฐะฝะธะต ะธะทะพะปะธัะพะฒะฐะฝะฝะพะน ะปะพะณะธะบะธ

```python
@pytest.mark.unit
@pytest.mark.asyncio
async def test_material_service_create(client_mock):
    """Unit ัะตัั ัะพะทะดะฐะฝะธั ะผะฐัะตัะธะฐะปะฐ"""
    # ะขะตัั ั ะฐะฒัะพะผะฐัะธัะตัะบะธะผะธ ะผะพะบะฐะผะธ
```

### Integration ัะตััั
- **ะะฐัะบะตั**: `@pytest.mark.integration`
- **ะะตะถะธะผ**: ะะตะฐะปัะฝัะต ะะ ะฟะพะดะบะปััะตะฝะธั
- **ะกะบะพัะพััั**: ะกัะตะดะฝะธะต (1-10 ัะตะบ ะฝะฐ ัะตัั)
- **ะะฐะทะฝะฐัะตะฝะธะต**: ะขะตััะธัะพะฒะฐะฝะธะต ะฒะทะฐะธะผะพะดะตะนััะฒะธั ะบะพะผะฟะพะฝะตะฝัะพะฒ

```python
@pytest.mark.integration
@pytest.mark.asyncio
async def test_materials_database_workflow(client_real):
    """ะะฝัะตะณัะฐัะธะพะฝะฝัะน ัะตัั ะฟะพะปะฝะพะณะพ workflow"""
    # ะขะตัั ั ัะตะฐะปัะฝัะผะธ ะะ
```

### Functional ัะตััั
- **ะะฐัะบะตั**: `@pytest.mark.functional`
- **ะะตะถะธะผ**: ะะพะปะฝัะต end-to-end ััะตะฝะฐัะธะธ
- **ะกะบะพัะพััั**: ะะตะดะปะตะฝะฝัะต (5-30 ัะตะบ ะฝะฐ ัะตัั)
- **ะะฐะทะฝะฐัะตะฝะธะต**: ะขะตััะธัะพะฒะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปััะบะธั ััะตะฝะฐัะธะตะฒ

### Performance ัะตััั
- **ะะฐัะบะตั**: `@pytest.mark.performance`
- **ะะตะถะธะผ**: ะะฐะณััะทะพัะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต
- **ะกะบะพัะพััั**: ะัะตะฝั ะผะตะดะปะตะฝะฝัะต (30+ ัะตะบ ะฝะฐ ัะตัั)
- **ะะฐะทะฝะฐัะตะฝะธะต**: ะขะตััะธัะพะฒะฐะฝะธะต ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

## ๐ง ะะพะฝัะธะณััะฐัะธั

### ะะตัะตะบะปััะตะฝะธะต ัะตะถะธะผะพะฒ

ะกะธััะตะผะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพะฟัะตะดะตะปัะตั ัะตะถะธะผ ัะตััะธัะพะฒะฐะฝะธั:

```bash
# Mock ัะตะถะธะผ (ะฟะพ ัะผะพะปัะฐะฝะธั)
pytest -m unit

# ะะตะฐะปัะฝัะต ะะ
TEST_MODE=real pytest -m integration
```

### ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

ะัะฝะพะฒะฝัะต ะฟะตัะตะผะตะฝะฝัะต ะฒ `tests/conftest.py`:

- `TEST_MODE` - ัะตะถะธะผ ัะตััะธัะพะฒะฐะฝะธั (`mock`/`real`)
- `QDRANT_URL` - URL Qdrant ะดะปั ัะตััะพะฒ
- `QDRANT_API_KEY` - API ะบะปัั Qdrant
- `DISABLE_REDIS_CONNECTION` - ะพัะบะปััะธัั Redis
- `DISABLE_POSTGRESQL_CONNECTION` - ะพัะบะปััะธัั PostgreSQL

## ๐ ะะฐะฟะธัะฐะฝะธะต ัะตััะพะฒ

### ะกะพะณะปะฐัะตะฝะธั ะพ ะธะผะตะฝะพะฒะฐะฝะธะธ

```python
def test_[component]_[action]_[expected_result]():
    """
    ะขะตัั [ะพะฟะธัะฐะฝะธะต ะฝะฐ ััััะบะพะผ]
    Test [description in English]
    """
```

### ะกัััะบัััะฐ ัะตััะพะฒะพะน ััะฝะบัะธะธ

```python
@pytest.mark.unit
@pytest.mark.asyncio
async def test_service_create_material_success():
    """Unit ัะตัั ััะฟะตัะฝะพะณะพ ัะพะทะดะฐะฝะธั ะผะฐัะตัะธะฐะปะฐ"""
    # Arrange - ะฟะพะดะณะพัะพะฒะบะฐ ะดะฐะฝะฝัั
    material_data = {"name": "Test Material", "price": 100.0}
    
    # Act - ะฒัะฟะพะปะฝะตะฝะธะต ะดะตะนััะฒะธั
    result = await service.create_material(material_data)
    
    # Assert - ะฟัะพะฒะตัะบะฐ ัะตะทัะปััะฐัะฐ
    assert result.name == "Test Material"
    assert result.price == 100.0
```

### ะัะฟะพะปัะทะพะฒะฐะฝะธะต ัะธะบัััั

```python
def test_with_fixtures(sample_material, mock_database_services):
    """ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ัะธะบัััั"""
    # sample_material - ะณะพัะพะฒัะต ัะตััะพะฒัะต ะดะฐะฝะฝัะต
    # mock_database_services - ะทะฐะผะพะบะฐะฝะฝัะต ัะตัะฒะธัั
    pass
```

## ๐ ะคะธะบััััั

### ะัะฝะพะฒะฝัะต ัะธะบััััั

- `client_mock` - ัะตััะพะฒัะน ะบะปะธะตะฝั ั ะผะพะบะฐะผะธ
- `client_real` - ัะตััะพะฒัะน ะบะปะธะตะฝั ั ัะตะฐะปัะฝัะผะธ ะะ
- `client` - ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฒัะฑะพั ะบะปะธะตะฝัะฐ
- `sample_material` - ะพะฑัะฐะทะตั ะผะฐัะตัะธะฐะปะฐ
- `sample_price_data` - ะพะฑัะฐะทัั ัะตะฝะพะฒัั ะดะฐะฝะฝัั
- `test_supplier_id` - ID ัะตััะพะฒะพะณะพ ะฟะพััะฐะฒัะธะบะฐ

### Mock ัะธะบััััั

- `mock_materials_service` - Mock ัะตัะฒะธัะฐ ะผะฐัะตัะธะฐะปะพะฒ
- `mock_vector_db` - Mock ะฒะตะบัะพัะฝะพะน ะะ
- `mock_qdrant_client` - Mock Qdrant ะบะปะธะตะฝัะฐ
- `mock_openai_client` - Mock OpenAI ะบะปะธะตะฝัะฐ

### ะคะธะบััััั ะดะฐะฝะฝัั

ะัะต ัะตััะพะฒัะต ะดะฐะฝะฝัะต ัะตะฝััะฐะปะธะทะพะฒะฐะฝั ะฒ `fixtures/data_fixtures.py`:

```python
from tests.fixtures.data_fixtures import TestDataProvider

# ะะพะปััะตะฝะธะต ะพะฑัะฐะทัะพะฒ ะผะฐัะตัะธะฐะปะพะฒ
materials = TestDataProvider.get_sample_materials()

# ะะพะปััะตะฝะธะต CSV ะดะฐะฝะฝัั
csv_data = TestDataProvider.get_price_list_csv_data()
```

## ๐ ะะพะผะฐะฝะดั Makefile

### ะัะฝะพะฒะฝัะต ะบะพะผะฐะฝะดั
- `make test-unit` - Unit ัะตััั
- `make test-integration` - ะะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั
- `make test-functional` - ะคัะฝะบัะธะพะฝะฐะปัะฝัะต ัะตััั
- `make test-performance` - ะขะตััั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ
- `make test-all` - ะัะต ัะตััั

### ะะพะฟะพะปะฝะธัะตะปัะฝัะต ะบะพะผะฐะฝะดั
- `make test-coverage` - ะขะตััั ั ะฐะฝะฐะปะธะทะพะผ ะฟะพะบัััะธั
- `make test-fast` - ะขะพะปัะบะพ ะฑัััััะต ัะตััั
- `make test-verbose` - ะะตัะฐะปัะฝัะน ะฒัะฒะพะด
- `make clean-test` - ะัะธััะบะฐ ัะตััะพะฒัั ัะฐะนะปะพะฒ

### ะะพะผะฑะธะฝะธัะพะฒะฐะฝะฝัะต ะบะพะผะฐะฝะดั
- `make test-quick` - ะัััััะต unit ัะตััั
- `make test-ci` - ะขะตััั ะดะปั CI/CD
- `make test-full` - ะะพะปะฝัะน ัะธะบะป ัะตััะธัะพะฒะฐะฝะธั

## ๐ ะะฝะฐะปะธะท ะฟะพะบัััะธั

```bash
# ะะตะฝะตัะฐัะธั ะพััะตัะฐ ะพ ะฟะพะบัััะธะธ
make test-coverage

# ะัะพัะผะพัั HTML ะพััะตัะฐ
open htmlcov/index.html
```

## ๐ ะัะปะฐะดะบะฐ ัะตััะพะฒ

### ะะฐะฟััะบ ะบะพะฝะบัะตัะฝะพะณะพ ัะตััะฐ
```bash
pytest tests/unit/test_api_endpoints.py::test_health_check -v
```

### ะะฐะฟััะบ ัะตััะพะฒ ะฟะพ ะฟะฐััะตัะฝั
```bash
make test-pattern PATTERN="material"
```

### ะะตัะฐะปัะฝัะน ะฒัะฒะพะด
```bash
make test-verbose
```

### ะััะฐะฝะพะฒะบะฐ ะฝะฐ ะฟะตัะฒะพะน ะพัะธะฑะบะต
```bash
pytest -x tests/
```

## ๐ CI/CD ะธะฝัะตะณัะฐัะธั

### GitHub Actions ะฟัะธะผะตั
```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Install dependencies
        run: make install-test-deps
      - name: Run unit tests
        run: make test-unit
      - name: Run integration tests
        run: make test-integration
        env:
          TEST_MODE: real
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
```

## ๐ ะะตััะธะบะธ ะธ ะผะพะฝะธัะพัะธะฝะณ

### ะะตััะธะบะธ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ
- ะัะตะผั ะฒัะฟะพะปะฝะตะฝะธั ัะตััะพะฒ
- ะะพะบัััะธะต ะบะพะดะฐ
- ะะพะปะธัะตััะฒะพ ะฟัะพะนะดะตะฝะฝัั/ะฝะตัะดะฐัะฝัั ัะตััะพะฒ
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฟะฐะผััะธ

### ะะพะฝะธัะพัะธะฝะณ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
```bash
# ะัะพัะธะปะธัะพะฒะฐะฝะธะต ัะตััะพะฒ
make test-profile

# ะะพะฝะธัะพัะธะฝะณ ัะตััััะพะฒ
pytest --profile-svg tests/
```

## ๐จ ะฃัััะฐะฝะตะฝะธะต ะฝะตะฟะพะปะฐะดะพะบ

### ะงะฐัััะต ะฟัะพะฑะปะตะผั

1. **ะขะตััั ะฟะฐะดะฐัั ั ะพัะธะฑะบะพะน ะฟะพะดะบะปััะตะฝะธั ะบ ะะ**
   - ะัะพะฒะตัััะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
   - ะฃะฑะตะดะธัะตัั ััะพ ะะ ะดะพัััะฟะฝั
   - ะัะฟะพะปัะทัะนัะต `TEST_MODE=mock` ะดะปั unit ัะตััะพะฒ

2. **ะะตะดะปะตะฝะฝัะต ัะตััั**
   - ะัะฟะพะปัะทัะนัะต `make test-fast` ะดะปั ะธัะบะปััะตะฝะธั ะผะตะดะปะตะฝะฝัั ัะตััะพะฒ
   - ะัะพะฒะตัััะต ะผะฐัะบะธัะพะฒะบั `@pytest.mark.slow`

3. **ะัะพะฑะปะตะผั ั ัะธะบััััะฐะผะธ**
   - ะัะพะฒะตัััะต ะธะผะฟะพััั ะฒ `conftest.py`
   - ะฃะฑะตะดะธัะตัั ััะพ ัะธะบััััั ะฟัะฐะฒะธะปัะฝะพ ะฟะพะผะตัะตะฝั

### ะะพะปััะตะฝะธะต ะฟะพะผะพัะธ
```bash
# ะกะฟะธัะพะบ ะฒัะตั ะบะพะผะฐะฝะด
make help

# ะะฐะปะธะดะฐัะธั ัะตััะพะฒ
make test-validate

# ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน  
make check-deps
```

## ๐ ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัะตััััั

- [ะะพะบัะผะตะฝัะฐัะธั pytest](https://docs.pytest.org/)
- [FastAPI Testing](https://fastapi.tiangolo.com/tutorial/testing/)
- [AsyncMock ััะบะพะฒะพะดััะฒะพ](https://docs.python.org/3/library/unittest.mock.html#unittest.mock.AsyncMock)

---

**ะะพัะปะตะดะฝะตะต ะพะฑะฝะพะฒะปะตะฝะธะต**: 2024  
**ะะตััะธั**: 1.0  
**ะกัะฐััั**: ะะบัะธะฒะฝะฐั ัะฐะทัะฐะฑะพัะบะฐ 