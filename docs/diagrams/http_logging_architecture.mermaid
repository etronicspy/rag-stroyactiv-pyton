graph TD
    subgraph "📥 HTTP Request Entry Point"
        A[HTTP Request] --> B[FastAPI App]
        B --> C[ASGI Middleware Stack]
    end
    
    subgraph "🔧 Middleware Stack (LIFO Order)"
        C --> D[TestMiddleware <br/>🧪 Debug Only]
        D --> E[LoggingMiddleware <br/>📝 HTTP Logging]
        E --> F[BodyCacheMiddleware <br/>💾 Request Body]
        F --> G[CompressionMiddleware <br/>🗜️ Response Compression]
        G --> H[SecurityMiddleware <br/>🔒 Security Headers]
        H --> I[RateLimitMiddleware <br/>⏱️ Rate Limiting]
        I --> J[CORSMiddleware <br/>🌐 CORS Headers]
    end
    
    subgraph "📊 Monitoring & Logging System"
        E --> K[UnifiedLoggingManager]
        K --> L[RequestLogger]
        K --> M[PerformanceOptimizer]
        K --> N[MetricsCollector]
        
        L --> O[Logger Instance Cache]
        M --> P[BatchProcessor]
        P --> Q[Log Queue]
        P --> R[Metric Queue]
        
        Q --> S[Background Batch Processing]
        R --> S
    end
    
    subgraph "🔍 Context Management"
        E --> T[CorrelationContext]
        T --> U[Correlation ID Generation]
        T --> V[Request Metadata Storage]
        U --> W[ContextVar Storage]
        V --> W
    end
    
    subgraph "📋 Logging Configuration"
        X[main.py] --> Y[setup_middleware]
        Y --> Z[MiddlewareFactory]
        Z --> AA[MiddlewareConfig]
        AA --> E
        
        BB[core/config] --> CC[Settings]
        CC --> E
        CC --> K
    end
    
    subgraph "📁 File Output & Processing"
        S --> DD[Console Handler]
        S --> EE[File Handler]
        DD --> FF[Colored/Structured Output]
        EE --> GG[Log Files]
    end
    
    subgraph "🚦 Request Flow Through LoggingMiddleware"
        E --> HH[should_exclude_path?]
        HH -->|No| II[Generate Correlation ID]
        HH -->|Yes| JJ[Skip Logging]
        II --> KK[Set Context Metadata]
        KK --> LL[Log Request Start]
        LL --> MM[Process Request]
        MM --> NN[Log Request Complete]
        NN --> OO[Record Performance Metrics]
        JJ --> MM
    end
    
    style A fill:#e1f5fe
    style E fill:#f3e5f5,stroke:#9c27b0,stroke-width:3px
    style K fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    style T fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style M fill:#f1f8e9,stroke:#689f38,stroke-width:2px 