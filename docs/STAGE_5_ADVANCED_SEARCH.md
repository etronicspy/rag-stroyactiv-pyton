# Stage 5: Advanced Search and Filtering

## –û–±–∑–æ—Ä / Overview

**Stage 5** —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è RAG Construction Materials API, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –º–æ—â–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π, –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

**Stage 5** implements advanced search and filtering capabilities for the RAG Construction Materials API, providing users with powerful tools for precise material search with comprehensive filtering, analytics, and performance optimization.

## –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ / Key Features

### üîç –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ç–∏–ø—ã –ø–æ–∏—Å–∫–∞ / Advanced Search Types
- **Vector Search**: –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
- **SQL Search**: –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ —Å PostgreSQL
- **Fuzzy Search**: –ù–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–π —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å—é
- **Hybrid Search**: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å –≤–µ—Å–æ–≤—ã–º–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏

### üéØ –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è / Comprehensive Filtering
- **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏**: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
- **–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è**: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –µ–¥–∏–Ω–∏—Ü–∞–º (–∫–≥, –º, –º¬≤, –º¬≥, —à—Ç)
- **SKU –ø–∞—Ç—Ç–µ—Ä–Ω—ã**: –ü–æ–∏—Å–∫ –ø–æ —à–∞–±–ª–æ–Ω–∞–º –∞—Ä—Ç–∏–∫—É–ª–æ–≤ —Å wildcards
- **–î–∏–∞–ø–∞–∑–æ–Ω—ã –¥–∞—Ç**: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- **–ü–æ—Ä–æ–≥–∏ —Å—Ö–æ–∂–µ—Å—Ç–∏**: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–æ—Ä–æ–≥–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞

### üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—è / Sorting and Pagination
- **–ú—É–ª—å—Ç–∏-–ø–æ–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞**: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ–ª—è–º
- **Cursor-based –ø–∞–≥–∏–Ω–∞—Ü–∏—è**: –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤
- **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: Ascending/Descending –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è

### üí° –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ / Smart Features
- **–ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ**: –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞**: HTML-–ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
- **–ü–æ–∏—Å–∫–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞**: –¢—Ä–µ–∫–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏–∑ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ / Architecture

```mermaid
graph TB
    subgraph "API Layer"
        AR[Advanced Search Routes]
        AR --> |POST /api/v1/search/advanced| ASE
        AR --> |GET /api/v1/search/suggestions| ASE
        AR --> |GET /api/v1/search/analytics| ASE
    end
    
    subgraph "Service Layer"
        ASE[AdvancedSearchService]
        ASE --> |Vector Search| VS[Vector Search Engine]
        ASE --> |SQL Search| SS[SQL Search Engine]
        ASE --> |Fuzzy Search| FS[Fuzzy Search Engine]
        ASE --> |Hybrid Search| HS[Hybrid Search Engine]
    end
    
    subgraph "Repository Layer"
        CMR[CachedMaterialsRepository]
        HMR[HybridMaterialsRepository]
        CMR --> HMR
    end
    
    subgraph "Database Layer"
        QDB[(Qdrant Vector DB)]
        PDB[(PostgreSQL)]
        RDB[(Redis Cache)]
    end
    
    subgraph "Analytics & Caching"
        SA[Search Analytics]
        SC[Search Cache]
        SG[Suggestions Generator]
    end
    
    VS --> CMR
    SS --> CMR
    FS --> CMR
    HS --> CMR
    
    CMR --> RDB
    HMR --> QDB
    HMR --> PDB
    
    ASE --> SA
    ASE --> SC
    ASE --> SG
    
    SA --> RDB
    SC --> RDB
    SG --> RDB
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã / Components

### 1. AdvancedSearchService

–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `advanced_search()` - –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞
- `_vector_search()` - –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
- `_sql_search()` - SQL –ø–æ–∏—Å–∫
- `_fuzzy_search()` - –ù–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫
- `_hybrid_search()` - –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
- `_apply_filters()` - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
- `_apply_sorting()` - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
- `_apply_pagination()` - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏

### 2. Advanced Search Routes

API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ –ø–æ–∏—Å–∫–∞:

```python
# –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–æ–∏—Å–∫
POST /api/v1/search/advanced

# –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
GET /api/v1/search/suggestions?q=—Ü–µ–º

# –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
GET /api/v1/search/popular-queries

# –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–∞
GET /api/v1/search/analytics

# –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
GET /api/v1/search/categories

# –î–æ—Å—Ç—É–ø–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã
GET /api/v1/search/units

# –ù–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫
POST /api/v1/search/fuzzy

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
GET /api/v1/search/health
```

### 3. –°—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö / Data Schemas

#### AdvancedSearchQuery
```python
{
    "query": "—Ü–µ–º–µ–Ω—Ç –ø–æ—Ä—Ç–ª–∞–Ω–¥—Å–∫–∏–π",
    "search_type": "hybrid",
    "filters": {
        "categories": ["–¶–µ–º–µ–Ω—Ç"],
        "units": ["–∫–≥"],
        "created_after": "2024-01-01T00:00:00",
        "min_similarity": 0.5
    },
    "sort_by": [
        {"field": "relevance", "direction": "desc"},
        {"field": "created_at", "direction": "desc"}
    ],
    "pagination": {
        "page": 1,
        "page_size": 20
    },
    "fuzzy_threshold": 0.8,
    "include_suggestions": true,
    "highlight_matches": true
}
```

#### SearchResponse
```python
{
    "results": [...],
    "total_count": 150,
    "page": 1,
    "page_size": 20,
    "total_pages": 8,
    "search_time_ms": 45.2,
    "suggestions": [...],
    "filters_applied": {...},
    "next_cursor": "eyJwYWdlIjoyLCJ0b3RhbCI6MTUwfQ=="
}
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è / Usage Examples

### 1. –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–æ–∏—Å–∫

```python
import httpx

# –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
search_query = {
    "query": "—Ü–µ–º–µ–Ω—Ç",
    "search_type": "hybrid",
    "filters": {
        "categories": ["–¶–µ–º–µ–Ω—Ç"],
        "units": ["–∫–≥"],
        "min_similarity": 0.7
    },
    "sort_by": [
        {"field": "relevance", "direction": "desc"}
    ],
    "pagination": {
        "page": 1,
        "page_size": 10
    },
    "highlight_matches": True,
    "include_suggestions": True
}

async with httpx.AsyncClient() as client:
    response = await client.post(
        "http://localhost:8000/api/v1/search/advanced",
        json=search_query
    )
    result = response.json()
    
    print(f"Found {result['total_count']} materials")
    for item in result['results']:
        print(f"- {item['material']['name']} (score: {item['score']:.3f})")
```

### 2. –ù–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫

```python
# –ù–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º –ø–æ—Ä–æ–≥–æ–º
async with httpx.AsyncClient() as client:
    response = await client.post(
        "http://localhost:8000/api/v1/search/fuzzy",
        params={
            "q": "—Ü–µ–º–Ω—Ç",  # –û–ø–µ—á–∞—Ç–∫–∞ –≤ —Å–ª–æ–≤–µ "—Ü–µ–º–µ–Ω—Ç"
            "threshold": 0.8,
            "limit": 5
        }
    )
    materials = response.json()
    
    for material in materials:
        print(f"- {material['name']}")
```

### 3. –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ

```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
async with httpx.AsyncClient() as client:
    response = await client.get(
        "http://localhost:8000/api/v1/search/suggestions",
        params={"q": "—Ü–µ–º", "limit": 5}
    )
    suggestions = response.json()
    
    for suggestion in suggestions:
        print(f"- {suggestion['text']} ({suggestion['type']})")
```

### 4. –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

```python
# –ü–æ–∏—Å–∫ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
search_query = {
    "query": "—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã",
    "search_type": "hybrid",
    "filters": {
        "categories": ["–¶–µ–º–µ–Ω—Ç", "–ö–∏—Ä–ø–∏—á", "–ú–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç"],
        "units": ["–∫–≥", "—à—Ç", "–º"],
        "sku_pattern": "*001",
        "created_after": "2024-01-01T00:00:00",
        "created_before": "2024-12-31T23:59:59",
        "min_similarity": 0.6
    },
    "sort_by": [
        {"field": "use_category", "direction": "asc"},
        {"field": "name", "direction": "asc"}
    ],
    "pagination": {
        "page": 1,
        "page_size": 20
    }
}
```

### 5. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–∞

```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ–∏—Å–∫–∞
async with httpx.AsyncClient() as client:
    response = await client.get(
        "http://localhost:8000/api/v1/search/analytics",
        params={
            "start_date": "2024-01-01T00:00:00",
            "end_date": "2024-01-31T23:59:59"
        }
    )
    analytics = response.json()
    
    print(f"Total searches: {analytics['total_searches']}")
    print(f"Average time: {analytics['avg_search_time']:.2f}ms")
    print("Popular queries:")
    for query in analytics['popular_queries'][:5]:
        print(f"- '{query['query']}': {query['count']} searches")
```

## –ê–ª–≥–æ—Ä–∏—Ç–º—ã –Ω–µ—á–µ—Ç–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ / Fuzzy Search Algorithms

### 1. Levenshtein Distance
–í—ã—á–∏—Å–ª—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –¥—Ä—É–≥—É—é.

```python
def levenshtein_similarity(s1: str, s2: str) -> float:
    """Calculate Levenshtein similarity (0.0 to 1.0)."""
    max_len = max(len(s1), len(s2))
    if max_len == 0:
        return 1.0
    
    distance = levenshtein_distance(s1, s2)
    return 1.0 - (distance / max_len)
```

### 2. Sequence Matcher
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º —Å—Ö–æ–∂–µ—Å—Ç–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π Python –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏.

```python
from difflib import SequenceMatcher

def sequence_matcher_similarity(s1: str, s2: str) -> float:
    """Calculate similarity using SequenceMatcher."""
    return SequenceMatcher(None, s1, s2).ratio()
```

### 3. Weighted Field Scoring
–ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç —Å—Ö–æ–∂–µ—Å—Ç–∏ –ø–æ —Ä–∞–∑–Ω—ã–º –ø–æ–ª—è–º —Å –≤–µ—Å–æ–≤—ã–º–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏:

```python
field_weights = {
    'name': 0.4,        # 40% - –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    'description': 0.3,  # 30% - –æ–ø–∏—Å–∞–Ω–∏–µ
    'use_category': 0.2, # 20% - –∫–∞—Ç–µ–≥–æ—Ä–∏—è
    'sku': 0.1          # 10% - –∞—Ä—Ç–∏–∫—É–ª
}
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å / Performance

### –ë–µ–Ω—á–º–∞—Ä–∫–∏ –ø–æ–∏—Å–∫–∞ / Search Benchmarks

| –¢–∏–ø –ø–æ–∏—Å–∫–∞ | –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è | –¢–æ—á–Ω–æ—Å—Ç—å | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|------------|---------------|----------|---------------|
| Vector     | 15-25ms       | –í—ã—Å–æ–∫–∞—è  | –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ |
| SQL        | 10-20ms       | –°—Ä–µ–¥–Ω—è—è  | –¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è |
| Fuzzy      | 50-100ms      | –í—ã—Å–æ–∫–∞—è  | –ü–æ–∏—Å–∫ —Å –æ–ø–µ—á–∞—Ç–∫–∞–º–∏ |
| Hybrid     | 30-60ms       | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π |

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ / Performance Optimization

1. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**:
   - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∫–µ—à–∏—Ä—É—é—Ç—Å—è –≤ Redis –Ω–∞ 5 –º–∏–Ω—É—Ç
   - –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–µ—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 1 —á–∞—Å
   - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 1 –¥–µ–Ω—å

2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**:
   - –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ —Ç–∏–ø—ã –ø–æ–∏—Å–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤

3. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è**:
   - Cursor-based –ø–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ 100 —ç–ª–µ–º–µ–Ω—Ç–æ–≤

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è / Configuration

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞ / Search Settings

```python
# services/advanced_search.py
class AdvancedSearchService:
    def __init__(self):
        # –í–µ—Å–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–∏—Å–∫–∞
        self.search_weights = {
            'vector': 0.5,
            'sql': 0.3,
            'fuzzy': 0.2
        }
        
        # –í–µ—Å–∞ –ø–æ–ª–µ–π –¥–ª—è –Ω–µ—á–µ—Ç–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
        self.field_weights = {
            'name': 0.4,
            'description': 0.3,
            'use_category': 0.2,
            'sku': 0.1
        }
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        self.cache_ttl = {
            'search_results': 300,    # 5 –º–∏–Ω—É—Ç
            'suggestions': 3600,      # 1 —á–∞—Å
            'analytics': 86400        # 1 –¥–µ–Ω—å
        }
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è / Environment Variables

```bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞
SEARCH_DEFAULT_PAGE_SIZE=20
SEARCH_MAX_PAGE_SIZE=100
SEARCH_DEFAULT_FUZZY_THRESHOLD=0.8
SEARCH_ANALYTICS_ENABLED=true

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
SEARCH_CACHE_TTL_RESULTS=300
SEARCH_CACHE_TTL_SUGGESTIONS=3600
SEARCH_CACHE_TTL_ANALYTICS=86400

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
SEARCH_PARALLEL_EXECUTION=true
SEARCH_MAX_CONCURRENT_SEARCHES=10
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ / Monitoring and Analytics

### –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–∏—Å–∫–∞ / Search Metrics

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
   - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫–µ—à

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
   - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
   - –¢–∏–ø—ã –ø–æ–∏—Å–∫–∞
   - –ü—Ä–∏–º–µ–Ω—è–µ–º—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã

3. **–ö–∞—á–µ—Å—Ç–≤–æ**:
   - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Å—Ö–æ–∂–µ—Å—Ç–∏
   - –ü—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
   - –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–∏—Å–∫–∏

### –î–∞—à–±–æ—Ä–¥ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ / Analytics Dashboard

```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
async def get_search_dashboard_metrics():
    analytics = await search_service.get_search_analytics()
    
    return {
        "total_searches_today": analytics["daily_stats"][today]["searches"],
        "avg_response_time": analytics["avg_search_time"],
        "popular_queries": analytics["popular_queries"][:10],
        "search_types_distribution": analytics["search_types"],
        "cache_hit_rate": await get_cache_hit_rate()
    }
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å / Security

### –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π / Abuse Protection

1. **Rate Limiting**:
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –∏ DDoS –∞—Ç–∞–∫

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
   - –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏**:
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–æ–∏—Å–∫–∞
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ / Deployment

### Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```dockerfile
# Dockerfile –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ –ø–æ–∏—Å–∫–∞
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ –ø–æ–∏—Å–∫–∞
ENV SEARCH_ANALYTICS_ENABLED=true
ENV SEARCH_CACHE_TTL_RESULTS=300

EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Kubernetes –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: advanced-search-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: advanced-search-api
  template:
    metadata:
      labels:
        app: advanced-search-api
    spec:
      containers:
      - name: api
        image: rag-materials-api:latest
        ports:
        - containerPort: 8000
        env:
        - name: SEARCH_ANALYTICS_ENABLED
          value: "true"
        - name: REDIS_HOST
          value: "redis-service"
        - name: QDRANT_HOST
          value: "qdrant-service"
        - name: POSTGRES_HOST
          value: "postgres-service"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ / Testing

### Unit —Ç–µ—Å—Ç—ã

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ –ø–æ–∏—Å–∫–∞
pytest tests/test_advanced_search.py -v

# –¢–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
pytest tests/test_advanced_search.py --cov=services.advanced_search
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

```bash
# –¢–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ë–î
pytest tests/test_advanced_search.py -m integration

# –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã
pytest tests/test_advanced_search.py -m performance
```

### –î–µ–º–æ-—Å–∫—Ä–∏–ø—Ç

```bash
# –ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
python utils/demo_advanced_search.py
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫ / Troubleshooting

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã / Common Issues

1. **–ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫**:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ PostgreSQL
   - –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

2. **–ù–µ—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã**:
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–µ—Å–∞ –ø–æ–ª–µ–π
   - –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥–∏ —Å—Ö–æ–∂–µ—Å—Ç–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

3. **–û—à–∏–±–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è**:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Redis
   - –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –ø–æ–∏—Å–∫–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TTL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ / Logging

```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞
import logging

logging.getLogger("services.advanced_search").setLevel(logging.INFO)
logging.getLogger("core.repositories.cached_materials").setLevel(logging.DEBUG)
```

## Roadmap / –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞

### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è / Planned Improvements

1. **Q1 2024**:
   - –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
   - A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤

2. **Q2 2024**:
   - –ü–æ–∏—Å–∫ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
   - –ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–∏—Å–∫
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∫–∞—Ç–∞–ª–æ–≥–∞–º–∏

3. **Q3 2024**:
   - –§–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
   - –ü—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–ø—Ä–æ—Å–∞

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ / Conclusion

Stage 5 –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–æ—â–Ω—É—é –∏ –≥–∏–±–∫—É—é —Å–∏—Å—Ç–µ–º—É –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ –ø–æ–∏—Å–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–∏—Å–∫–∞, –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–µ–ª–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –≥–æ—Ç–æ–≤–æ–π –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫—Ä—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö.

Stage 5 provides a powerful and flexible advanced search system that significantly improves user experience when working with construction materials catalog. The combination of different search types, intelligent filtering, and analytics makes the system ready for production use in large-scale projects. 